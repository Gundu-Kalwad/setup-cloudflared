name: Minecraft Bedrock Server
on: workflow_dispatch

jobs:
  run-mc:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip libcurl4 openssl python3-pip
          pip3 install gdown --break-system-packages

      - name: Download and Unzip from Drive
        run: |
          # Use gdown to download using your specific file ID
          gdown --id 1JS1Yc3Mwm_sY-kHczKfYLauCZ2-V-ExB -O bedrock.zip
          
          # Unzip into a temporary folder first
          mkdir -p temp_extracted
          unzip bedrock.zip -d temp_extracted
          
          # Find the actual bedrock_server file anywhere in the zip
          # and move it plus all its sibling files to the 'server' folder
          mkdir -p server
          SERVER_PATH=$(find temp_extracted -name "bedrock_server" -type f | head -n 1)
          mv $(dirname "$SERVER_PATH")/* server/
          chmod +x server/bedrock_server

      - name: Install Bore (Stable Cargo)
        run: |
          # Cargo is pre-installed on the runner; this is the most reliable install
          cargo install bore-cli

      - name: Start Server and Tunnel
        run: |
          cd server
          # Start the server in the background
          LD_LIBRARY_PATH=. ./bedrock_server &
          
          echo "Waiting 30s for the world to load..."
          sleep 30
          
          # Start the tunnel to get your Global IP
          ~/.cargo/bin/bore local 19132 --to bore.pub
